#!/usr/bin/env php
<?php

namespace Civi\SmartyClassifier;

require_once dirname(__DIR__) . '/vendor/autoload.php';

$prj = dirname(__DIR__);
$files = glob("$prj/examples/*.tpl");

$topParser = Services::createTopParser();
$tagParser = Services::createTagParser();
foreach ($files as $file) {
  echo "Process $file\n";

  $parsed = $topParser->parse(file_get_contents($file));

  foreach (Reports::getReportList() as $suffix => $generator) {
    $reportFile = preg_replace(';\.tpl$;', $suffix, $file);
    $fh = fopen($reportFile, 'w');
    call_user_func($generator, $fh, $parsed);
    fclose($fh);
  }

  $tagsDir = preg_replace(';\.tpl$;', '.tags', $file);
  Files::mkdir($tagsDir);
  Files::remove($tagsDir . '/*.tpl');
  Files::remove($tagsDir . '/*.tree');
  foreach ($parsed->findAll('stanza:tag') as $tag) {
    $string = (string) $tag;
    $id = md5($string);
    $parsedTag = $tagParser->parse($string);
    file_put_contents("$tagsDir/$id.tpl", $tag);
    file_put_contents("$tagsDir/$id.tree", var_export($parsedTag, TRUE));
  }

}
