#!/usr/bin/env php
<?php

namespace Civi\SmartyClassifier;

require_once dirname(__DIR__) . '/vendor/autoload.php';

$prj = dirname(__DIR__);
$files = glob("$prj/examples/*.tpl");

$topParser = Services::createTopParser();
$tagParser = Services::createTagParser();
foreach ($files as $file) {
  $reportDir = preg_replace(';\.tpl$;', '.d', $file);
  printf("Process %s => %s\n", $file, $reportDir);
  Files::mkdir($reportDir);

  $parsed = $topParser->parse(file_get_contents($file));
  foreach (Reports::getReportList() as $name) {
    Reports::writeFile($reportDir . '/' . "$name.txt", $name, $parsed);
  }

  Files::remove($reportDir . '/tag-*.tpl');
  Files::remove($reportDir . '/tag-*.tree');
  foreach ($parsed->findAll('stanza:tag') as $tag) {
    $string = (string) $tag;
    $id = md5($string);
    $parsedTag = $tagParser->parse($string);
    file_put_contents("$reportDir/tag-$id.tpl", $tag);
    Reports::writeFile("$reportDir/tag-$id.tree", 'tree', $parsedTag);
  }

}
